<!--
/*---------------------------------------------------------------------------------------------
*  Copyright (c) Microsoft Corporation. All rights reserved.
*  Licensed under the MIT License. See License.txt in the project root for license information.
*--------------------------------------------------------------------------------------------*/
@author: Babak Naderi
-->

<head>
	<title></title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/images.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8">
</head>



<style type="text/css">
body{font-family:Tahoma,"Times New Roman", Times, serif;}

.table th, .table td {
     border-top: none !important;
}
.center {
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 30%;
}

.baudio {margin:5px;}
.baudio .baudio_table{display: inline;}
.baudio .bn{margin:10px;}
.baudio td{text-align:center;}
.baudio .blabel{margin-top:50px;font-size: 70%;	color: #636363;}

.scale {font-size: 100%;}
.scale td { text-align: left; padding:0;}
.scale label { display:block;}
.scale .c { text-align: center;}
section {
	margin-bottom:15px;
	padding: 10px 10px;
	font-family: Verdana, Geneva, sans-serif;
	color:#333333;
	font-size:0.9em;
}
fieldset { padding: 10px; background:#fbfbfb; border-radius:5px; margin-bottom:5px; }
</style>

<script type="text/javascript">

/*
General configuration file:
  - cookieName: change it for each study, it will be used to monitor if the user has taken training, setup sections, and
 how many assignments they submitted to expose limits.
 - qualificationCookieName: name of cookie that shows the status of qualification section.
 - qualificationValidFor: how long the qualification cookie stay in minutes (43200 : 1 month)
 - forceRetrainingInHours: every X hours force the user to take part in training (recommendation: 1hour)
 - showSetupEveryMinutes: show the setup section every X minutes (recommendation: 15 minutes)
 - questionUrls: URLs to clips to be appeared in the Rating section. Either hard-coded or placeholders.
 - trainingUrls: URLs to clips to be appeared in the Training section. Either hard-coded or placeholders.
 - knownQuestionInTrainingUrl: Training may contain a question with known answer which worker will be forced to give the
 correct answer to.
 - knownQuestionInTrainingAns: the answer that should be selected by worker
 - knownQuestionUrl: the rating section may contain a question with known answer. It will be used in combination of the
 Assignment Review Policy.
 - knownQuestionAns: the answer that we expect from worker
 - randomizeTrainingQuestions: boolean whether the questions in the training section should be randomized on loading time.
 - randomizeRatingQuestions: boolean whether the questions in the rating section should be randomized on loading time.
 - allowedMaxHITsInProject: How many HITs each worker is allowed to answer in this project
 - allowedMaxContinuesSessionDurationInMinutes: how log is the maximum continue session. A break of 10min will be forced
*/
var config ={
	//title of the page and cookies names
	pageTitle:"Sample video quality assessment Task",
	cookieName:"sample task",
	qualificationCookieName:"sample qualification",
	//expiration date of cookies
	qualificationValidFor:43200,
    forceRetrainingInHours:1,
    showSetupEveryMinutes:30,
	//How long the session is allowed to last before forcing the participant to take a break
	sessionMaxLength:45,
	forcedBreak:10,
    debug:"false",
	//training and rating URLs
	trainingUrls: ["assets/training_videos/1.mp4","assets/training_videos/2.mp4","assets/training_videos/3.mp4"],
    questionUrls: ["assets/rating_videos/1.mp4","assets/rating_videos/2.mp4","assets/rating_videos/3.mp4","assets/rating_videos/4.mp4","assets/rating_videos/5.mp4"],
	// randomizing the questions
	randomizeTrainingQuestions:"true",
    randomizeRatingQuestions:"true",

	//trapping question in the training section
    knownQuestionInTrainingUrl:"assets/training_videos/1.mp4",
    knownQuestionInTrainingAns: "1",
	//trapping question in the rating section
    knownQuestionUrl:"assets/rating_videos/1.mp4",
    knownQuestionAns: "1",
	//golden question in the rating section
    goldClipURL:"assets/rating_videos/2.mp4",
    goldClipAns:"1",

	// how many HITS the participant is allowed to answer for this task
    allowedMaxHITsInProject:25,
	//contact email
	emailAddress: "beshtawi.ashraf@gmail.com",

	// automatic test config
	automatic_test:{
		// the total number of tests
		number_of_tests:5,
		//show detailed results about the reults of each test to the user
		general:{
			//show the result of each test 
			show_details:false,
			//show the result of each test 
			show_final_result:false,
			//success and fail messages
			fail:"One or more automatic tests failed. The cause might be your screen refresh-rate, the screen size, the size of the browser's window or the device you are using",
			success:"Automatic Tests passed. Please continue",
		},

		//Frame-rate test
		fps:{
			//the fps needed
			fps_value:60,
			//tolerance allowed
			tolerance_Percent:15,
			//success and fail messages
			fail:"Your Screen Framerate does not match the requirments for this task",
			success:"Screen Framerate Test passed. Please continue",
		},
		//screen dimensions test
		dimensions:{
			required_width:30,
			required_height:15,
			//success and fail messages
			fail:"Your Screen Dimesions do not match the requirments for this task",
			success:"Screen Dimesions Test passed. Please continue",
		},
		//window size
		window:{
			//should the brwoser's window be maximaized in size 
			maximized:true,
			//success and fail messages
			fail:"Your Browsers' window size does not match the requirments for this task",
			success:"Browsers' window size Test passed. Please continue",
		},
		//device check allowes to choose which devices are allowed to participate
		device:{
			//pc is allowd
			pc:true,
			//mobile is not allowed
			mobile:false,
			//success and fail messages
			fail:"Your Device Type does not match the requirments for this task",
			success:"Device Test passed. Please continue",			
		},
		browser:{
			//which browsers are allowed
			chrome:true,
			firefox: true,
			IE: false,
			//success and fail messages
			fail:"Your Browser does not match the requirments for this task. Please use another browser",
			success:"Browser Test passed. Please continue",	
		}

	},
	//sample video to be shown to the participant in the setup section
	sample_video:{
		//url of the video
		link:"assets/sample_video/sample.mp4",
		// optional thumbnail (if set to "" the thumbnail will be a frame from the video)
		thumbnail:"",
		//these are the default values
		height:400,
		width:600,
	},


	// Just noticable difference config
	// distance from screen (blur)
	blur:{
		// path and format of the images to be used
		path:"assets/jnd_distance",
		format:"jpg",
		//SNR pairs (snr1,snr2, correct snr)
		snr_pairs:[[1,10,10],[2,10,10],[7,4,7]],
		//the number of correct answers required to pass the blur test
		correct_answers_requested:2,
		//allowed distance
		max_allowed_distance:3,
		min_allowed_distance:0.5,
	},

	brightness:{
		// path and format of the images to be used
		path:"assets/jnd_brightness",
		format:"jpg",
		//SNR levels (for each entry in the array one question will be generated
		snr:[1,5,7],
		//the number of correct answers required to pass the brightness test
		correct_answers_requested:3,
		// the numbers in the sample (dont change anything here)
		num_array: ["024","093","135","156","246","282","286","289","340","359","401","468","534","591","626","628","680","802","815","913","962"],
	
	}
}

// if performing of this assignment is already counted
var hitCounterIncreased = false;
// record the errors happened in the page
var generalErrorLog= "";

// how many times a feedback was given to the workers,
var n_cmp_feedbacks = 0;

const Hide_HIT_REASON = Object.freeze({"MAX_ACHIVED":1, "QUALIFICATON":2})
/*
Initializing the page: generate and hide sections depending to the cookies value
*/
$(function() {
	try{
		// disable logs if not debug
		if (!JSON.parse(config['debug'])){
			console.log = function() {};
		}
		loadTextPlaceHolders();
		if(readCookie(config.cookieName+"training")=="done"){

			document.getElementById("hidden_info").innerHTML+=`<input type="hidden" id="training_done_in_older_session" name="training_done_in_older_session" value="true"> `;
			$("#training").hide();
		}
		generate_training_section();
		generate_rating_section();
		avoidAnsweringBeforeListeningThrough();
		cookie_debug_status="";
		// given cookie availability disable the qualification
		qual_passed= readCookie(config['qualificationCookieName']);
		console.log(qual_passed);

		if (qual_passed!==null && qual_passed=="done"){
			$('.qualificationFieldset').prop("disabled", true);
			$("#qualification").hide();
			$("#qualification :input").removeAttr("required");
			cookie_debug_status=cookie_debug_status+"ACR_LISTENER Exist*";
		}



		hit_num = readCookie(config['cookieName']+"_counter");
		howManyHITsAnswered =0;
		if (hit_num != null ){
			howManyHITsAnswered= Number(hit_num);
			if (howManyHITsAnswered >= config['allowedMaxHITsInProject']){
				disableTheHIT(Hide_HIT_REASON.MAX_ACHIVED);
			}
		}
		if ((qual_passed!==null) && (qual_passed=="false")){
			disableTheHIT(Hide_HIT_REASON.QUALIFICATON);
		}

		hitCounterIncreased = false;
		cookie_debug_status=cookie_debug_status+"Counter:"+howManyHITsAnswered+"*";
		addBrowserInfo(cookie_debug_status);


		// for qualification section
		initializeQualification();
		initializeActivePageMonitoring();

	}catch(err){
		console.error(err);
		recordError(err.name,err.message);

	}
});

var overAllHiddenTime = 0;
var startHiddenDate = null;
var sessionId = null;
var sessionIdVariableName=null;
/**
	monitor and record the status of page including being focus, and active time

**/
function initializeActivePageMonitoring(){
	sessionId = Math.random().toString(36).substr(2, 9);
	sessionIdVariableName = config.qualificationCookieName +"_sid";
	createCookie(sessionIdVariableName,sessionId,70);

	document.addEventListener("visibilitychange", function() {
		var isHidden = document.hidden;
		if (isHidden){
			startHiddenDate = new Date();
		}else{
			//get back the focus
			stopHiddenDate = new Date();
			diff = stopHiddenDate -startHiddenDate;
			overAllHiddenTime = overAllHiddenTime + diff;
			$('#time_page_hidden_sec').val(overAllHiddenTime/1000);
		}
		console.log( "document_hidden: "+ document.hidden + "time: "+overAllHiddenTime);

	});
}

/**
	check if there is any parallel session available.
**/
function isAnyParallelSession(){
	hit_num = readCookie(sessionIdVariableName);
	if (hit_num != sessionId){
		$('#any_parallel_session').val("true");
		console.log("parallel session.")
		return true;
	}
	return false;

}

/**
 central method to record errors
**/
function recordError(name, message){
	generalErrorLog =generalErrorLog + " Error "+name+": "+message+";%0D%0A"
	$('#errors').val(generalErrorLog);
	$("#errorEmail").attr("href","mailto:"+config["emailAddress"]+"?subject=Error on HIT Load&body="+generalErrorLog);
	$("#errorSection").show();
}

/*
	Initialize the qualification section
*/
var qualification_ans= new Set();
function initializeQualification(){
	randomizeHearingtestItems();
    makeCheckboxBeRequired();
    forceNoSpaceInInput();
    $("#qualification :input").on('change', isQualificationDone);
}
/*
	check if the qualification all answered
*/
function isQualificationDone(){
	//checking the gender
	let participant_gender=false;
	let gender_radio=document.getElementsByName("1_gender");
	for (let index = 0; index < 3; index++) {
		if(gender_radio[index].checked){
			participant_gender=true;
			break;
		}	
	}
	//checking the brithyear
	let brithyear_text=document.getElementsByName("2_birth_year")[0].value.length>0? true : false;
	//checking the mother lang
	let mother_tongue_text=document.getElementsByName("3_mother_tongue")[0].value.length>0? true : false;
	//check 5_last_subjective and 6_video_test
	let last_subjective_select=document.getElementsByName("5_last_subjective")[0].selectedIndex>0? true : false;
	let video_test_select=document.getElementsByName("6_video_test")[0].selectedIndex>0? true : false;	
	// working area check 7_working_area
	let working_area=false;
	let working_area_radio=document.getElementsByName("7_working_area");
	for (let index = 0; index < 2; index++) {
		if(working_area_radio[index].checked){
			working_area=true;
			break;
		}	
	}
	//checking for color blindness 9_color_blindness
	let color_blindness=false;
	let color_blindness_radio=document.getElementsByName("9_color_blindness");
	for (let index = 0; index < 4; index++) {
		if(color_blindness_radio[index].checked){
			color_blindness=true;
			break;
		}	
	}
	//evaluating the results
	if(participant_gender && brithyear_text && mother_tongue_text && last_subjective_select &&video_test_select &&working_area && color_blindness){
			// add a qualification for 'qualificationValidFor' minutes
			createCookie(config.qualificationCookieName,"done",config.qualificationValidFor);
	}



}



/*
	randomize clips in the hearing test
*/
function randomizeHearingtestItems(){
    var cards = $(".rnd");
	for(var i = 0; i < cards.length; i++){
		var target = Math.floor(Math.random() * cards.length -1) + 1;
		var target2 = Math.floor(Math.random() * cards.length -1) +1;
		cards.eq(target).before(cards.eq(target2));
    }
}
/*
	Make a checkbox group to be required
*/
function makeCheckboxBeRequired(){
    var requiredCheckboxes = $('.4_lds :checkbox[required]');
    requiredCheckboxes.change(function(){
        if(requiredCheckboxes.is(':checked')) {
            requiredCheckboxes.removeAttr('required');
        } else {
            requiredCheckboxes.attr('required', 'required');
        }
    });
}
/*
	Avoid space in text field
*/
function forceNoSpaceInInput(){
    $(".nospace").on({
          keydown: function(e) {
            if (e.which === 32)
              return false;
          },
          change: function() {
            this.value = this.value.replace(/\s/g, "");
          }
        });
}

/*
Change placeholders inside text with values from config file.
*/
function loadTextPlaceHolders(){
	// update the instruction
	$('.max_allowed_hits').html(config['allowedMaxHITsInProject']);
	$('.setup_time').html(config['showSetupEveryMinutes']);
	$('.training_time').html(config['forceRetrainingInHours']);

}

/*
Store the following information in hidden input field which will be added to answerc.sv by AMT
userAgent, cookieEnabled, appVersion, platform, language, status of 3 cookies.
*/
function addBrowserInfo(debug){
	info="U_A:"+navigator.userAgent+";"+
		"CookieEnabled:"+navigator.cookieEnabled+";"+
		"AppV:"+navigator.appVersion+";"+
		"Platform:"+navigator.platform+";"+
		"LN:"+navigator.language+";"+
		"cookie_debug:"+debug+";";

	$('#browser_info').val(info);
	console.log(info);

}

//-------- check qual num online
function checkQualNumCorrect(given_ans, correct_hash){
	return btoa(given_ans) == correct_hash;
}
// ------------------------ online check cmp




//--------------- Utilities -----------------

/*
	Utility function to format strings
*/
String.prototype.format = String.prototype.f = function() {
    var s = this,
        i = arguments.length;
    while (i--) {
        s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
    }
    return s;
};

/*
	Utility: convert seconds to MM:SS
*/
String.prototype.toMMSS = function () {
    var sec_num = parseInt(this, 10); // don't forget the second param
    var minutes   = Math.floor(sec_num / 60);
    var seconds = sec_num - (minutes * 60);
    if (minutes < 10) {minutes = "0"+minutes;}
    if (seconds < 10) {seconds = "0"+seconds;}
    return minutes+':'+seconds;
}

/*
	Disable the HIS and show a proper message.
	- used when the maximum number of HITs in project is reached
*/
function disableTheHIT(c){
	$("#qualification").hide();
	$("#training").hide();
	$("#setup").hide();
	$("#rating_section").hide();
	$("#Survey").hide();
	$("#thanks").hide();
	$("#device_check_section").hide();

	if (c == Hide_HIT_REASON.MAX_ACHIVED)
		$("#max_allowed_HITs_reached").show();
	if (c == Hide_HIT_REASON.QUALIFICATON)
		$("#qualification_rejected").show();
}

/*
	Add a cookies with corresponding values
*/
function createCookie(name, value, minutes) {
    var expires;
    if (minutes) {
        var date = new Date();
        date.setTime(date.getTime() + (minutes * 60 * 1000));
        expires = date.toGMTString();
    } else {
        expires = "";
    }

    let st =value +";"+ expires ;
    console.log(st);
    localStorage.setItem(name, st);
}



/*
	Update the cookie which counts the number of Assignments performed by user. Increase it by "updateBy" value.
*/
function updateCounterCookie(name, updateBy){
	expiry_in_a_month= 30*24*60
	c = readCookie(name);
	if (c==null){
		createCookie(name, 1, expiry_in_a_month);
		return 1;
	}else{
	 	console.log(c);
	 	createCookie(name, Number(c)+updateBy, expiry_in_a_month);
	}
	return Number(c)+updateBy;
}

/*
	Return the value of cookie, or null
*/
function readCookie(name) {
	var storedValue = localStorage.getItem(name);
	if (storedValue){
		let infos = storedValue.toString().split(';');
		let value = infos[0];
		let validUntil = new Date(infos[1]);
		let today = new Date();
		if (today<=  validUntil)
			return value;
		else{
			localStorage.removeItem(name);
			return null;
		}
	}else
		return null;
}




/*
	Remove the variable from local storage
*/
function removeCookie(name) {
	localStorage.removeItem(name);
}

/*
	Callback when "Next" in Rating section is clicked.
*/
function showNextQuestionInRatingSection(){
	var count = $("#nav-tab-ul li").length;
	id=$("#nav-tab-ul li.active").index();
	if (id+2==count){
		$('#next-rating').addClass('disabled');
	}
	id=id+2;
	$('#nav-tab-ul li:nth-child('+id+') a').tab('show');

}

/*
	Callback when "Previous" in Rating section is clicked.
*/
function showPreviousQuestionInRatingSection(){
	id=$("#nav-tab-ul li.active").index();
	id=id;
	$('#nav-tab-ul li:nth-child('+id+') a').tab('show');
	var count = $("#nav-tab-ul li").length;
	if (id+1<=count)
		$('#next-rating').removeClass('disabled');
}

/*
	Callback when "Next" in Training section is clicked.
*/
function showNextQuestionInTrainingSection(){
	var count = $("#trainingTabs li").length;
	id=$("#trainingTabs li.active").index();
	if (id+1!=count){
		id=id+2;
		$('#trainingTabs li:nth-child('+id+') a').tab('show');
	}else{
		// last next is called

		setTimeout(function (){
			window.location.hash="navNextPre";
		},  50);
	}
}

/*
	Callback when "Previous" in Training section is clicked.
*/
function showPreviousQuestionInTrainingSection(){
	id=$("#trainingTabs li.active").index();
	id=id;
	$('#trainingTabs li:nth-child('+id+') a').tab('show');
}


var trainingStimulusPlayed;
var problematic_urls="";
/*
	Called when the scale item is clicked
*/
function alertForbiddenChange(){
	alert('You should watch the clip until the end.');
	$(this).prop('checked', false);
}

/*
	Users should not be able to vot before watching the clips until the end.
*/
function avoidAnsweringBeforeListeningThrough(){
	var i;
	// Training section
	for (i = 0; i < config['trainingUrls'].length; i++) {
		$('input[name="t{0}"]'.f(i+1)).on('change', alertForbiddenChange);
	}
	// Rating section
	for (i = 0; i < config['questionUrls'].length; i++) {
		$('input[name="q{0}"]'.f(i+1)).on('change', alertForbiddenChange);
	}
}

/*
	Listener on value change for the Gold question.
	if the answer is correct, change the value of gq_check to 0.
*/
function onValueChangeForGoldQuestion(){
	//check if training is finished
	TrainingFinishedCheck();

	let ans = $( this ).val()
	let expectedVal = parseInt(config['goldClipAns'])
	if ( expectedVal -1 <=ans && ans <= expectedVal +1 )
		$('#gq_check').val(0);
	else
		$('#gq_check').val(-1);
	console.log($('#gq_check').val())
}

/*
	Listener on value change for the trapping question.
	if the answer is correct, change the value of tp_check to 0.
*/
function onValueChangeForTpQuestion(){
	//check if training is finished
	TrainingFinishedCheck();


	if ($( this ).val()  == parseInt(config['knownQuestionAns']))
		$('#tp_check').val(0);
	else
		$('#tp_check').val(-1);
	//console.log("gc_check"+$('#tp_check').val())
}

/*
	Listener on value change for the trapping question in training.
	if the answer is wrong, show a message.
*/
function onValueChangeForTpQuestionInTraining(){
	if ($( this ).val()  != config['knownQuestionInTrainingAns']){
		alert('Error: In case you hear an interruption message, please follow the instruction given in the message.');
		$(this).prop('checked', false);
	}

}

/*
	Called when the video in rating section by the given id is completely played.
	Now user can rate the quality.
*/
function playedVideoQ(id){

	// parallel session check
	isAnyParallelSession();
	// check if it was the trapping question or golden question
	if ($('div[id="'+id+'"]').attr("link") == config['knownQuestionUrl']){
		element = $('input[name="'+id+'"]');
		element.unbind();
		element.on('change', onValueChangeForTpQuestion);
	}else if ($('div[id="'+id+'"]').attr("link") == config['goldClipURL']){
		element = $('input[name="'+id+'"]');
		element.unbind();
		element.on('change', onValueChangeForGoldQuestion);
	}else if($('div[id="'+id+'"]').attr("link") == config['knownQuestionInTrainingUrl']){
		element = $('input[name="'+id+'"]');
		element.unbind();
		element.on('change', onValueChangeForTpQuestionInTraining);
	}else{
		element = $('input[name="'+id+'"]');
		element.unbind();
		element.on('change', TrainingFinishedCheck);
		// check if already this HIT is counted
		if (!hitCounterIncreased){
			updateCounterCookie(config['cookieName']+"_counter",1);
			hitCounterIncreased=true
		}
	}
}


function TrainingFinishedCheck() {
	//getting the number of tabs
	let count = $("#trainingTabs li").length;
	let done_counter=0;

	//looping over the tabs
	for (let index = 1; index <= count; index++) {
		
		let this_tab_result=false;
		//selecting the radio buttons in the tab
		let this_tab=document.getElementsByName(`t${index}`);
		//looping over the radio buttons
		for (let i = 0; i < 5; i++) {
			if(this_tab[i].checked){
				this_tab_result=true;
				break;
			}	
		}
		//if a choice in this tab is selected then incerement counter
		if(this_tab_result){
			done_counter++;
		}

	}
	//check if all tabs are done then set cookie for training as done
	if(done_counter==count){
		createCookie(config.cookieName+"training","done",config.forceRetrainingInHours*60);
	}
}


</script>



<script type="text/javascript">

/*
	shuffle function for randomization of items -->
*/
function shuffle(a) {
	var j, x, i;
	for (i = a.length - 1; i > 0; i--) {
		j = Math.floor(Math.random() * (i + 1));
		x = a[i];
		a[i] = a[j];
		a[j] = x;
	}
	return a;
}

/*
	Generate the training section
*/
function generate_training_section(){
	acr_nav_tab = '<li class="nav-item {1}"><a class="nav-link " data-toggle="tab"  href="#T{0}-panel" id="T{0}-tab " role="tab" aria-controls="T{0}" {2}>Q. {0}</a></li>';
	acr_tab ='<div class="tab-pane fade {2}" id="T{0}-panel" role="tabpanel" aria-labelledby="T{0}-tab"><p></p><div class="row">	<div class="col-sm-3"></div>	<div class="col-sm-6">		<p style="margin-top:10px;">{0}. How do you rate the <b>overall quality</b> of the following video sample? </p><p align="center"> <div class="vid" id="t{0}" callback="playedVideoQ" link="{1}" width="600" height="400" ></div> </p><fieldset id="fieldset_t{0}" class="trainingFieldset" title=""><table class="table md scale" cellspacing="0" cellpadding="0">			<thead><tr><th >Quality of the Video</th><th class="c" >Score</th></tr>			</thead>			<tbody><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="5">Excellent</label></div></td><td class="c">5</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="4">Good</label></div></td><td class="c">4</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="3">Fair</label></div></td><td class="c">3</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="2">Poor</label></div></td><td class="c">2</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="1"required="">Bad</label></div></td><td class="c">1</td></tr>	   </tbody></table>		</fieldset><p></p> </div> 	<div class="col-sm-3"></div></div> <p></p> </div>';
	// this will show which url was shown by in which question as their orther will be randomized
	input_template= '<input id="T{0}_URL" name="T{0}_URL" type="hidden" value="{1}" />';

    if (JSON.parse(config['randomizeTrainingQuestions']))
		urls = shuffle(config['trainingUrls']);
	else
		urls = config['trainingUrls'];

	var i;
	for (i = 0; i < urls.length; i++) {
		if (i==0){
			$('#trainingTabs').append(acr_nav_tab.f(i+1,'active', 'ria-selected="true"'));
			$('#nav-tabContent').append(acr_tab.f(i+1, urls[i],'in active'));
		}else{
			$('#trainingTabs').append(acr_nav_tab.f(i+1,'',''));
			$('#nav-tabContent').append(acr_tab.f(i+1, urls[i],''));
		}
		$('#av-tabContent').append(input_template.f(i+1, urls[i]));
	}
	$('.question_number_training').html(urls.length);
	trainingStimulusPlayed = new Array(urls.length).fill(0);
}

/*
	Generate rating section
*/
function generate_rating_section(){
	acr_nav_tab = '<li class="nav-item {1}"><a class="nav-link" data-toggle="tab" href="#Q{0}-panel" id="Q{0}-tab" role="tab" aria-controls="Q{0}" {2}>Q. {0}</a></li>';
	acr_tab ='<div class="tab-pane fade {2}" id="Q{0}-panel" role="tabpanel" aria-labelledby="q{0}-tab"> <p></p> <div class="row"> <div class="col-sm-3"></div> <div class="col-sm-6"> <p style="margin-top:10px;">{0}. How do you rate the <b>overall quality</b> of the following video sample? </p> <p align="center"> <div class="vid" id="q{0}" callback="playedVideoQ" link="{1}" width="600" height="400" ></div> </p> <fieldset id="fieldset_q{0}" title=""> <table class="table md scale" cellspacing="0" cellpadding="0"> <thead> <tr><th >Quality of the speech</th><th class="c" >Score</th></tr> </thead> <tbody> <tr><td><div class="radio" ><label ><input type="radio" name="q{0}" value="5">Excellent</label></div></td><td class="c">5</td></tr> <tr><td><div class="radio" ><label ><input type="radio" name="q{0}" value="4">Good</label></div></td><td class="c">4</td></tr> <tr><td><div class="radio" ><label ><input type="radio" name="q{0}" value="3">Fair</label></div></td><td class="c">3</td></tr> <tr><td><div class="radio" ><label ><input type="radio" name="q{0}" value="2">Poor</label></div></td><td class="c">2</td></tr> <tr><td><div class="radio" ><label ><input type="radio" name="q{0}" value="1"required="">Bad</label></div></td><td class="c">1</td></tr> </tbody> </table> </fieldset> <p></p> </div> <div class="col-sm-3"></div> </div> <p></p> </div>';
	// this will show which url was shown by in which question as their orther will be randomized
	input_template= '<input id="Q{0}_URL" name="Q{0}_URL" type="hidden" value="{1}" />';
	if (JSON.parse(config['randomizeRatingQuestions'])){
		urls = shuffle(config['questionUrls']);
	}else{
		urls = config['questionUrls'];
	}

	var i;
	for (i = 0; i < urls.length; i++) {
		if (i==0){
			$('#nav-tab-ul').append(acr_nav_tab.f(i+1,'active', 'ria-selected="true"'));
			$('#nav-tabContent-rating').append(acr_tab.f(i+1, urls[i],'in active'));
		}else{
			$('#nav-tab-ul').append(acr_nav_tab.f(i+1,'',''));
			$('#nav-tabContent-rating').append(acr_tab.f(i+1, urls[i],''));
		}
		$('#nav-tabContent-rating').append(input_template.f(i+1,urls[i]));
	}
	$('.question_number').html(urls.length);

}
</script>

<!--    Error -->
<section class="container" id="errorSection" hidden>
	<div class="alert alert-danger" role="alert" >
		<h5>Error</h5>
		<p>One or more errors are detected during loading this HIT. Please use the following link to send the error to us: <a class="email"  id="errorEmail"title="Email in HIT" href="">Email</a>.</p>
		<p><b> Meanwhile, please return this HIT and try another one</b>.</p>
	</div>
</section>
<!--    Break -->
<section class="container" id="breakSection" hidden >
	<div  class="panel panel-warning">
		<div class="panel-heading">Break</div>
		<div class="panel-body">
			<p>The maximum session length reached. please wait and take a break for <span id="maxTime"></span> minutes before continuing.</p> <br />
			<p>Dont worry  you will be able to continue with the survey soon. No Progress is lost, please <strong> don't</strong> close the window.</p>
		</div>
	</div>
</section>

<!-- Instructions -->
<div id="wholeServey">
<section class="container" id="Survey">
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">
				<a data-target="#instruction" data-toggle="collapse" >Instructions for Video quality assessment</a>
			</h3>
		</div>
		<div  class="panel-collapse collapse in" id="instruction">
			  <div class="panel-body" >
			  <b>Introduction</b>


				<img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/process_3.png" alt="scale" class="center" style='width: 60%' >

				  <p>Welcome! You are about to participate in our video quality assessment experiment! This HIT has two + two (just every now and then) sections:</p>
				<ul>
					<li><b>Qualification (just once):</b> Check if you are eligible to perform these HITs</li>
					<li><b>Setup (every <b class="setup_time"> 0</b> minutes):</b> Configure your system and validate it by answering 6 questions</li>
					<li><b>Training (every <b class="training_time"> 0 </b> hour):</b> <b class="question_number_training"> 0 </b> questions, same as "Ratings" but appears just once a day</li>
					<li><b>Rating:</b> watch <b class="question_number"> 0 </b> video files and give <b>your opinion about the quality of the video </b> you see.</li>
				</ul>
				<p>Note that not all of the speech in these video files is in English.</p>
				<p>You should follow the below mentioned rules, otherwise your answers will be invalid.</p>
				<p><b>Rules:</b></p>
				<ul>
					<li>You must use a <b>wide-screen device</b>(Desktop,notebook,..), not a mobile phone: otherwise your response will be rejected</li>
					<li>You must perform the task in a <b>well lit environment</b></li>
					<li>Your screen brightness must be adjusted to a comfortable level, so that you can recognise what is being shown on the screen.</li>
					<li>You must be 50 cm or closer to the screen.</li>
					<li>Do not change your distance to the screen or the lighting conditions of the room or the screen brightness after modifying it in the Setup section.</li>
				</ul>

				<p><b>Payment:</b></p>
				<p>The result of this experiment is <b>very important for us and other scientist</b> working in this area. We have methods that analyse the consistency of your answers. We will use these methods to rank the submitted assignments according to quality.</p>
				<p>For this experiment, we will pay a base reward of <b>${{cfg.hit_base_payment}}/HIT</b> for every accepted HIT. We have made available a set of <b class="max_allowed_hits">0 </b> different HITs. You will receive a bonus of:</p>

				<ul>
				  <li>${{cfg.quantity_bonus}}/HIT (for a total of <b>${{cfg.sum_quantity}}/HIT</b>) if you submit <b>more than {{cfg.quantity_hits_more_than}} HITs</b> or</li>
				  <li>${{cfg.quality_bonus}}/HIT (for a total of <b>${{cfg.sum_quality }}/HIT</b>) if you submit <b>more than {{cfg.quantity_hits_more_than}} HITs</b> <u>and</u> be in the <b>top {{cfg.quality_top_percentage}}% quality group</b>.</li>
				</ul>

				<p>Bonuses will be assigned with in 7 days.</p>
				  <b>Please perform up to <b class="max_allowed_hits"> 0 </b> HITs from this group. If you do more than that, the <u>rest will be rejected.</u></b>
			</div>
		</div>

	</div>
</section>


<!-- Qualification -->
<section class="container" id="qualification">

<div class="row col-xs-12 col-md-12">
<div class="panel panel-info">
  <div class="panel-heading">
    <h3 class="panel-title">
		<a data-toggle="collapse" href="#collapse1">Qualification - Just once</a>
	</h3>
  </div>
  <div id="collapse1" class="panel-collapse collapse in">
	  <div class="panel-body">

		<fieldset class="qualificationFieldset"><label>1.&nbsp;What is your gender?</label>
				<div class="radio">
				  <label><input type="radio" name="1_gender" value="M" required="">Male</label>
				</div>
				<div class="radio">
				  <label><input type="radio" name="1_gender" value="F">Female</label>
				</div>
				<div class="radio disabled">
				  <label><input type="radio" name="1_gender" value="O">Other</label>
				</div>
		</fieldset>
		<fieldset class="qualificationFieldset"><label>2.&nbsp;In what year were you born? </label>
				<div class="form-group">
				  <input type="number" class="form-control" name="2_birth_year" required="">
				</div>
		</fieldset>

		<fieldset class="qualificationFieldset"><label>3.&nbsp;What is your mother tongue? </label>
				<div class="form-group">
				  <input type="text" class="form-control" name="3_mother_tongue" required="">
				</div>
		</fieldset>


		<fieldset class="qualificationFieldset"><label>4.&nbsp; What type of devices do you have and able to use now (select all)?</label>

			<div class="table-responsive 4_lds">
			  <table class="table" border="0" cellpadding="0" cellspacing="0" >
				<tbody>
					<tr>
						<td style="width:25%"> <img src="assets/device/desktop.png" alt="desktop" width="100px"> </td>
						<td style="width:25%"> <img src="assets/device/notebook.png" alt="notebook" width="100px"> </td>
						<td style="width:25%"> <img src="assets/device/mobile.png" alt="mobile" width="100px"> </td>
						<td style="width:25%"> <img src="assets/device/tablet.png" alt="tablet" width="100px"> </td>
					</tr>
					<tr>
						<td><div class="checkbox"><label><input type="checkbox" value="desktop" name="4_ld" required>Desktop</label></div></td>
						<td><div class="checkbox"><label><input type="checkbox" value="notebook" name="4_ld" required>Notebook</label></div></td>
						<td><div class="checkbox"><label><input type="checkbox" value="mobile" name="4_ld" required>Mobile phone</label></div></td>
						<td><div class="checkbox"><label><input type="checkbox" value="tablet" name="4_ld" required>Tablet</label></div></td>
					</tr>

				</tbody>
			  </table>
			</div>

		</fieldset>

		<fieldset class="qualificationFieldset">
				 <div class="form-group">
				  <label for="sel1">5.&nbsp;When was the last time you participated in <span title="Giving your opinion about a product or media, for example what is the over all quality of this video. "><u>a subjective test</u></span>?</label>
				  <select class="form-control" id="sel1" name="5_last_subjective" required="">
					<option value="">Please select</option>
					<option value="0d">Today</option>
					<option value="3d">In last 3 days</option>
					<option value="7d">In last week</option>
					<option value="30d">In last month</option>
					<option value="nn">Never participated</option>
				  </select>
				</div>
		</fieldset>

		<fieldset class="qualificationFieldset">
				 <div class="form-group">
				  <label for="sel2">6.	When was the last time you participated in an <span title="Giving your opinion about an video sample"><u>video rating test</u></span>?</label>
				  <select class="form-control" id="sel2" name="6_video_test" required="">
					<option value="">Please select</option>
					<option value="0d">Today</option>
					<option value="3d">In last 3 days</option>
					<option value="7d">In last week</option>
					<option value="30d">In last month</option>
					<option value="nn">Never participated</option>
				  </select>
				</div>
		</fieldset>

		<fieldset class="qualificationFieldset"><label>7.&nbsp;Have you ever been directly involved in work connected with the video quality assessment, or related work?</label>
				<div class="radio">
				  <label><input type="radio" name="7_working_area" value="Y" required="">Yes</label>
				</div>
				<div class="radio">
				  <label><input type="radio" name="7_working_area" value="N">No</label>
				</div>
		</fieldset>

		<fieldset class="qualificationFieldset"><label>8.&nbsp; I belive, ...</label>
				<div class="radio">
				  <label><input type="checkbox" name="8_seeing" value="normal" required="">&nbsp;I have a normal vision.</label>
				</div>
				<div class="radio">
				  <label><input type="checkbox" name="8_seeing" value="nearsightedness">&nbsp;I have nearsightedness.</label>
				</div>
				<div class="radio">
				  <label><input type="checkbox" name="8_seeing" value="farsightedness">&nbsp;I have farsightedness.</label>
				</div>
				<div class="radio">
				  <label><input type="checkbox" name="8_seeing" value="Diabetic_retinopathy">&nbsp;I have Diabetic retinopathy. </label>
				</div>
				<div class="radio">
					<label><input type="checkbox" name="8_seeing" value="blindness">&nbsp;I have complete blindness. </label>
				  </div>
		</fieldset>


		<fieldset class="qualificationFieldset"><label>8.&nbsp; I belive, ...</label>
			<div class="radio">
			<div class="radio">
				<label><input type="radio" name="9_color_blindness" value="no_color_blindness">I have no color blindness.</label>
			</div>
			  <label><input type="radio" name="9_color_blindness" value="Red_green_blindness">I have Red green color blindness.</label>
			</div>
			<div class="radio">
			  <label><input type="radio" name="9_color_blindness" value="Blue_yellow_blindness">I have Blue yellow color blindness.</label>
			</div>
			<div class="radio">
			  <label><input type="radio" name="9_color_blindness" value="Complete_color_blindness">I have Complete color blindness.</label>
			</div>

	</fieldset>




<!--here was part 10-->		
	  </div>
  </div>
</div>

</div>
</section>


<!-- Setup -->
<section class="container" id="setup">
<div class="panel panel-info">
  <div class="panel-heading">
    <h3 class="panel-title">
		<a data-target="#setup_panel" data-toggle="collapse" >Setup (every <b class="setup_time"> a </b> minutes)</a>
	</h3>
  </div>
  <div  class="panel-collapse collapse in" id="setup_panel">
	  <div class="panel-body">
<!--automatic tests-->	
		<fieldset id="automaticTestsWhole" class="setupFieldset" ><label>0.&nbsp;Automatic tests.</label>
			<div id="automaticTests_div">
				<div id="panelFPS" class="panel panel-warning">
				<div class="panel-heading">Screen refresh-rate check</div>
				<div id="resultFPS" class="panel-body">Testing the screen refresh-rate ...</div>
				</div>

				<div id="panelDevice"  class="panel panel-warning">
				<div  class="panel-heading">Screen dimensions check</div>
				<div id="resultDevice" class="panel-body"></div>
				</div>
				
				<div id="windowSizePanel" class="panel panel-warning">
					<div class="panel-heading">Window Size check</div>
					<div id="windowSizeResult" class="panel-body"></div>
				</div>

				<div id="mobilePanel" class="panel panel-warning">
					<div class="panel-heading">Mobile phone check</div>
					<div id="mobileResult" class="panel-body"></div>
				</div>
				<div id="BrowserPanel" class="panel panel-warning">
					<div class="panel-heading">Browser check</div>
					<div id="BrowserResult" class="panel-body"></div>
				</div>
			</div>

			<div id="HardwareResult" class="alert alert-warning" role="alert">
			Hardware Tests are being conducted
			</div>


			<div id="dpi" style="width: 1cm; left: 100%; position: fixed; top: 100%;"></div>
		</fieldset>
		<br>
			<!--/automatic tests-->	
			<!--sample video-->	
		<fieldset class="setupFieldset" ><label>1.&nbsp;Please adjust your distance from the computer and the brightness of the screen to <b>a comfortable level</b> so that you see the following video sample very well.</label>

			<div class="alert alert-warning" role="alert">
			  <b>NOTE:</b> After that, you are not allowed to change the distance to the screen or the screen brightness anymore. Otherwise your response will be rejected.
			</div>
			<div align="center"> <div class="vid" id="sample_video" callback=console.log link="" width="600" height="400" ></div> </div>

		</fieldset>
		<br>
			<!--/sample video-->
			<!--JND distance-->	
			<div id="jnd_distance_whole">
			<fieldset class="setupFieldset" >
				<label>2.&nbsp; Which sample has a better quality compared to the other one? </label>
				<div id="JND_distance"></div>

			</fieldset>
			</div>
			<!--/JND distance-->	

			<!--JND brightness-->	
			<div id="jnd_brightness_whole" >
				<fieldset class="setupFieldset" >
					<label>3.&nbsp; Enter the number you see in the images in the textbox: </label>
					<div id="JND_brightness" class="row"></div>
					<div id="JND_brightness_button"></div>

				</fieldset>
				</div>
			<!--/JND brightness-->			


	  </div>
  </div>
</div>

</section>
<!-- Setup  ends-->


<!-- Training section, appears once a day-->
<section class="container" id="training">
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h3 class="panel-title">
					<a data-target="#trainingS" data-toggle="collapse" >Training (every <b class="training_time"> 0 </b> hour(s))</a>
				</h3>
			</div>
			<div  class="panel-collapse collapse in" id="trainingS">
				<div class="panel-body">
				<p> Please answer the following <b class="question_number_training"> 0 </b> questions. For each question, please watch to the video sample and give your opinion about the quality of the video you see on the following scale. <b>Note</b> that the scale will be activated when the video sample played until the end. In case you see an interruption message, please follow the instruction given in the message.</p>
				<p> There is no right or wrong answer as long as you watch to the video files and give your opinion.</p>

 				<!-- will be generated -->
				<ul class="nav nav-tabs" role="tablist" id="trainingTabs">
				</ul>

				<div class="tab-content" id="nav-tabContent">


				</div>
			<div style="margin-top:0px;font-size:90%;text-align:center">Click <b>next</b> to answer all <b class="question_number_training"> 0 </b> questions.</div>
			<nav aria-label="..." id="navNextPreT">
			  <ul class="pager">
				<li class="previous" onclick="showPreviousQuestionInTrainingSection();"><a href="#trainingTabs" class="page-link"  role="button"><span aria-hidden="true">&larr;</span>Previous</a></li>
				<li class="next" onclick="showNextQuestionInTrainingSection();"><a href="#trainingTabs" class="page-link"  role="button">Next <span aria-hidden="true">&rarr;</span></a></li>
			  </ul>
			</nav>

			</div>
			</div>
		</div>

</section>
<!-- Training section ends-->

<input id="tp_check" name="tp_check" type="hidden" value="-1" />
<input id="gq_check" name="gq_check" type="hidden" value="-1" />
<input id="errors" name="errors" type="hidden" value="" />

<input id="browser_info" name="browser_info" type="hidden" value="-1" maxlength="2000"/>
<input id="webrtc_raw" name="webrtc_raw" type="hidden" value="-1" maxlength="2000"/>
<input id="use_headset" name="use_headset" type="hidden" value="-1" />

<input id="time_page_hidden_sec" name="time_page_hidden_sec" type="hidden" value="0" />
<input id="any_parallel_session" name="any_parallel_session" type="hidden" value="false" />
<!--- Rating task -->
<section class="container" id="rating_section">
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h3 class="panel-title">Ratings</h3>
			</div>
			<div class="panel-body">
				<p> Please answer the following <b class="question_number"> 0 </b> questions. For each question, please watch to the video sample and give your opinion about the quality of the video you see on the following scale. <b>Note</b> that the scale will be activated when the video sample played until the end. In case you see an interruption message, please follow the instruction given in the message.</p>
				<p> There is no right or wrong answer as long as you watch to the video files and give your opinion.</p>

 				<!-- will be generated -->
				<ul class="nav nav-tabs" role="tablist" id="nav-tab-ul"> </ul>
				<!-- will be generated -->
				<div class="tab-content" id="nav-tabContent-rating">	</div>
				<div style="margin-top:0px;font-size:90%;text-align:center">Click <b>next</b> to answer all <b class="question_number">0</b> questions, then submit your response.</div>
				<nav aria-label="..." id="navNextPre">
				  <ul class="pager">
					<li class="previous" id="prev-rating" onclick="showPreviousQuestionInRatingSection();"><a href="#navNextPre" class="page-link"  role="button" ><span aria-hidden="true">&larr;</span>Previous</a></li>
					<li class="next" id= "next-rating" onclick="showNextQuestionInRatingSection();" ><a href="#navNextPre" class="page-link"  role="button">Next <span aria-hidden="true">&rarr;</span></a></li>
				  </ul>
				</nav>

			</div>
		</div>
</section>


<section class="container" id="thanks">
	<p>Thanks for your participation. Please perform more HITs from this group when they are available for you.</p>
</section>

</div>
<section class="container" id="max_allowed_HITs_reached" hidden>
	<p><h2>Well done! </h2> You performed the maximum number of HITs that you were allowed to.</p>

	<div class="alert alert-danger" role="alert">
		<img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/attention.png" alt="attention">
			  <b>NOTE:</b> Performing more HITs
		than what is explained in the description is forbidden and leads ro rejection of all of your submissions.
			</div>

</section>

<section class="container" id="qualification_rejected" hidden>
	<p>There is no assignments that match to your profile now. Please try it again in two-weeks time.
	We thank you for your participation.</p>

	<div class="alert alert-danger" role="alert">
		<img src="https://audiosamplesp808.blob.core.windows.net/p808-assets/img/attention.png" alt="attention">
			  <b>NOTE:</b> Any try to perform assignments and neglecting this message is forbidden and leads ro rejection of all of your submissions.
			</div>
</section>

<!--hidden inputs-->
<fieldset id="hidden_info">
			<!--results of automatic tests-->	
			<input type="hidden" id="automaticTests" name="automaticTests" value="false">
			<input type="hidden" id="jnd_distance_result" name="jnd_distance_result" value="false">
			<input type="hidden" id="jnd_brightness_result" name="jnd_brightness_result" value="false">
</fieldset>

<!--script for reading the data from config-->
<script>
	//setting the title
	document.getElementsByTagName("title")[0].innerHTML=config.pageTitle;
	//setting the link of sample video in the setupsection
	let sample_video=document.getElementById("sample_video");
	sample_video.setAttribute("link",config.sample_video.link);
	
	sample_video.setAttribute("height",config.sample_video.height);
	sample_video.setAttribute("width",config.sample_video.width);
	//setting poster if given
	let my_poster=config.sample_video.thumbnail
	// not null & not empty && not only spaces
	if(my_poster!=null && my_poster != "" && my_poster.match("[^ ]")){
		sample_video.setAttribute("poster",my_poster);
	}
	
</script>
<!--scripts for automatic tests-->
<script>
const NumberOfTests=config.automatic_test.number_of_tests;
const CallBackAllPassed=passedAll;
const CallBackAnyFailed=AnyFailed;

//hide the automatic tests if the config say so
if(!config.automatic_test.show_final_result){
	let tests_div_whole=document.getElementById("automaticTestsWhole");
	tests_div_whole.setAttribute("style","display: none;");
} else if(!config.automatic_test.general.show_details){
	let tests_div=document.getElementById("automaticTests_div");
	tests_div.setAttribute("style","display: none;");
}



//all tests were passed
function passedAll(){
  let HardwareResult=document.getElementById("HardwareResult");
  let hiddenResult=document.getElementById("automaticTests");

  hiddenResult.setAttribute("value","true");
  HardwareResult.setAttribute("class","alert alert-success");
  HardwareResult.innerHTML=config.automatic_test.general.success;

}

//at least one test failed
function AnyFailed(){
  let HardwareResult=document.getElementById("HardwareResult");
  HardwareResult.setAttribute("class","alert alert-danger");
  HardwareResult.innerHTML=config.automatic_test.general.fail;
}


</script>
<script src="assets/js/utility.js"></script>
<script src="assets/js/combinedTests.js"></script>
<script src="assets/js/fps.js"></script>
<script src="assets/js/screenSize.js"></script>
<script src="assets/js/WindowSize.js"></script>
<script src="assets/js/device.js"></script>
<script src="assets/js/browser.js"></script>
<script src="assets/js/break.js"></script>
<!--/scripts for automatic tests-->


<!--scripts for video player -->
<script src="assets/js/videoComponent.js"></script>
<!--scripts for video player-->


<!--scripts for JND -->
<script src="assets/js/jnd_distance.js"></script>
<script src="assets/js/jnd_brightness.js"></script>
<!--scripts for JND-->

